name: AI Code Review

permissions:
  pull-requests: write
  contents: write

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai_code_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install openai requests

      - name: Get PR Diff
        id: pr_diff
        run: |
          echo "DIFF<<EOF" >> $GITHUB_ENV
          gh pr diff ${{ github.event.pull_request.number }} --repo ${{ github.repository }} >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run OpenAI Code Review
        id: review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF: ${{ env.DIFF }}
          GITHUB_OUTPUT: $GITHUB_OUTPUT # If your script writes outputs
        run: |
          curl -s https://gist.githubusercontent.com/admondtamang/cd9f9e8dab91aad68b31a56a2ed21307/raw/d68a0a6977a55ba5c48664a42528aad86a3a07ae/pr-review.py > pr-review.py
          python pr-review.py

      - name: Post Critical Feedback
        if: steps.review.outputs.has_critical == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### üõë Critical Issues
            ${{ steps.review.outputs.critical }}

      - name: Post Warnings
        if: steps.review.outputs.has_warning == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ‚ö†Ô∏è Warnings
            ${{ steps.review.outputs.warning }}

      - name: Post Info
        if: steps.review.outputs.has_info == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ‚ÑπÔ∏è Suggestions
            ${{ steps.review.outputs.info }}
